---
# Change these:
auth_ldap_domain: None
auth_ldap_domain_ldap: None
auth_ldap_domain_suffix: None
# You'll want to generate this with `/usr/sbin/slappasswd -h {SSHA}`
auth_ldap_admin_pwd: None
auth_ldap_admin_pwd_clear: None
auth_ldap_sync_pwd_clear: None
auth_ldap_init_source: False
auth_kerberos_ldap_password_ldap: False
auth_kerberos_ldap_password: False
auth_kerberos_database_master_key: False

auth_ldap_group: core

# TLS for openLDAP
auth_ldap_have_tls: True
auth_ldap_ssl_cert_path: /etc/ldap/server.pem
auth_ldap_ssl_key_path: /etc/ldap/server.key
auth_ldap_ssl_ca_path: /etc/ldap/ca.pem

# Enctypes for recent kerberos
auth_kerberos_enctypes: "aes256-cts-hmac-sha384-192 aes128-cts-hmac-sha256-128"

# Users to create
auth_ldap_users: []

# Users to grant 'read' permission on Users subtree
auth_ldap_allow_read:
  - "cn=krbbind,ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}"

auth_ldap_services:
  - dns
  - ldap
  - host

auth_ldap_service_bases:
  - name: dns
    objectClass:
      - top
      - nsContainer

auth_ldap_service_accounts:
  - host: "{{ ansible_fqdn }}"
    service: ldap
    keytab: /etc/dirsrv/ds.keytab
    ktowner: dirsrv
    ktgroup: root
    ktmode: "0640"
  - host: "{{ ansible_fqdn }}"
    service: host
    keytab: /etc/krb5.keytab
    ktowner: dirsrv
    ktgroup: root
    ktmode: "0600"
  - host: "{{ ansible_fqdn }}"
    service: DNS
    keytab: /etc/bind/ldap.keytab
    ktowner: bind
    ktgroup: root
    ktmode: "0640"

# Permissions
auth_ldap_data_permissions:
  - target: "{{ auth_ldap_domain_ldap }}"
    acls:
      - (target="ldap:///{{ auth_ldap_domain_ldap }}")(targetattr = "cn || dn || uid || objectClass")(version 3.0; acl "Allow anonymous searches at root of tree"; allow(read, search, compare) userdn="ldap:///anyone";)
  - target: "ou=Users,{{ auth_ldap_domain_ldap }}"
    acls:
      - (target="ldap:///ou=Users,{{ auth_ldap_domain_ldap }}")(targetattr = "*")(version 3.0; acl "Allow kerberos service account access to sensitive user fields"; allow(all) userdn="ldap:///cn=krbbind,ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}";)
  - target: "ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}"
    acls:
      - (target="ldap:///ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}")(targetattr = "*")(version 3.0; acl "Allow kerberos service account access to sensitive user fields"; allow(all) userdn="ldap:///cn=krbbind,ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}";)
  - target: "cn=Kerberos,{{ auth_ldap_domain_ldap }}"
    acls:
      - (targetattr=*)(version 3.0; acl "Allow kerberos service account access to kerberos subtree"; allow(all) userdn="ldap:///cn=krbbind,ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}";)
  - target: "cn=dns,{{ auth_ldap_domain_ldap }}"
    acls:
      - (targetattr=*)(version 3.0; acl "Allow DNS service accounts access to DNS subtree"; allow(all) userdn="ldap:///uid=*,ou=dns,ou=TechnicalUsers,{{ auth_ldap_domain_ldap }}";)

# System user, do not touch!
auth_ldap_system_users:
  - name: krbbind
    id: krbbind
    uid: 10001
    gid: 1000
    initialPassword: "{{ auth_kerberos_ldap_password_ldap }}"
